---
layout: page
title:  "Exploratory Structural Equation Modeling in R"
subtitle: ""
date:   2023-12-04 21:21:21 +0530
categories: ["Factor Analysis"]
---

<h2><strong>Exploratory Structural Equation Modeling (ESEM) Implementation in R</strong></h2>
<p>In the previous article, I introduced the Mplus implementation of ESEM. This article will share the R code for implementing ESEM.</p>
<p>To implement ESEM in R, the following steps need to be followed:</p>
<ol>
    <li><strong>Estimate the factor loadings of the items using Exploratory Factor Analysis (EFA).</strong></li>
    <li><strong>Specify the SEM/CFA model based on the results of EFA.</strong></li>
</ol>

<p>Below, I will illustrate this process with an example: Although the four-factor structure of the Depression Scale of the Epidemiology Center has been validated in many studies, the results from exploratory factor analysis are inconsistent (Kim, DeCoster, Huang, & Chiriboga, 2011). For example, Guarnaccia et al. (1989) found a three-factor structure in the Spanish population, where positive emotion and interpersonal problems were separate factors, but depressive mood and somatic symptoms were combined into one factor (Guarnaccia, Angel, & Worobey, 1989). Therefore, I will use the four-factor model of this scale to explain ESEM. The data used is from a public database in China, and you do not need to focus on the specific values as it will not affect your understanding of the R code.</p>

    # Loading Packages and Reading the Data
    <pre><code>library(lavaan)
    library(psych)
    library(readxl)

    # Read the data
    dep <- read_xlsx("D:/future_plan/new_method/advance SEM/CES-D.xlsx", sheet = 1)
    head(dep)
    </pre>

    <p>To briefly explain the advantages of ESEM, we first conduct Confirmatory Factor Analysis (CFA) to check the model fit:</p>
    <pre><code># Set the model
d.model <- 'dep =~ b1 + b3 + b6 + b9 + b10 + b14 + b17 + b18
            pos =~ b4 + b8 + b12 + b16
            som =~ b2 + b5 + b7 + b11 + b13 + b20
            rel =~ b15 + b19'

# Estimate the model
d.cfa <- lavaan::cfa(d.model, data = dep, estimator = "MLR")

# Output model fit measures
fitmeasures(d.cfa, c("cfi.robust","tli.robust","rmsea.robust","srmr"))
</code></pre>

    <p>Now, let's formally proceed with the implementation of Exploratory Structural Equation Modeling (ESEM) in R.</p>

    <h2>Step 1: Exploratory Factor Analysis (EFA)</h2>
    <pre><code>d.efa <- fa(dep[, 4:23], nfact = 4, rotate = "geominQ", fm = "ml")
fa.diagram(d.efa)
</code></pre>

    <h2>Step 2: Incorporating the Results of EFA into the Model</h2>
    <pre><code># Create a 20x4 matrix from the factor loadings
d.loadmat <- zapsmall(matrix(round(d.efa$loadings, 2), nrow = 20, ncol = 4))

# Name the rows of the matrix
rownames(d.loadmat) <- colnames(dep[, 4:23])

# Concatenate the loadings with the items to form the CFA model for ESEM
terms <- vector()
for (i in 1:4) {
    terms[i] <- paste0("F", i, " =~ ", paste0(c(d.loadmat[, i]), "*", names(d.loadmat[, 1]), collapse = "+"))
}
d.esem <- paste(terms, collapse = "\n")
d.esem
</code></pre>

    <h2>Step 3: Conducting Confirmatory Factor Analysis (CFA) on the ESEM Model</h2>
    <pre><code># Perform CFA
d.cfa2 <- lavaan::cfa(d.esem, data = dep, verbose = FALSE, estimator = "MLR")

# Check the model fit
fitmeasures(d.cfa2, c("cfi.robust", "tli.robust", "rmsea.robust", "srmr"))
</code></pre>

    <p>From the above results, we can see that the ESEM model performs significantly better than the CFA model. Additionally, we can also attempt to use EFA to test the measurement invariance of the CES-D scale across gender.</p>

    <h2>Testing Measurement Invariance of CES-D Across Gender</h2>

    <h3>First, Configural Invariance:</h3>
    <pre><code>model1 <- cfa(model = d.esem, data = dep, group = "gender", estimator = "MLR")
fitmeasures(model1, c("cfi.robust","tli.robust","rmsea.robust","srmr"))
</code></pre>
    <p>From the results above, the CES-D scale demonstrates configural invariance across gender.</p>

    <h3>Second, Metric Invariance:</h3>
    <pre><code>model2 <- cfa(model = d.esem, data = dep, group = "gender", 
             group.equal = c("loadings"), estimator = "MLR")
fitmeasures(model2, c("cfi.robust","tli.robust","rmsea.robust","srmr"))
</code></pre>
    <p>From these results, the CES-D scale meets the criteria for metric invariance (the difference between models <code>model2</code> and <code>model1</code> CFA is &lt; 0.1, and the RMSEA difference is &lt; 0.015).</p>

    <h3>Third, Scalar Invariance:</h3>
    <pre><code>model3 <- cfa(model = d.esem, data = dep, group = "gender", 
             group.equal = c("loadings","intercepts"), estimator = "MLR")
fitmeasures(model3, c("cfi.robust","tli.robust","rmsea.robust","srmr"))
</code></pre>
    <p>From the results, the CES-D scale satisfies the criteria for scalar invariance (the difference between models <code>model3</code> and <code>model2</code> CFA is &lt; 0.1, and the RMSEA difference is &lt; 0.015).</p>

    <h3>Finally, Strict Invariance:</h3>
    <pre><code>model4 <- cfa(model = d.esem, data = dep, group = "gender", 
             group.equal = c("loadings","intercepts", "residuals"), estimator = "MLR")
fitmeasures(model4, c("cfi.robust","tli.robust","rmsea.robust","srmr"))
</code></pre>
    <p>From the results, the CES-D scale meets the criteria for strict invariance (the difference between models <code>model4</code> and <code>model3</code> CFA is &lt; 0.1, and the RMSEA difference is &lt; 0.015). This means that the ESEM-derived model has excellent invariance across gender.</p>
